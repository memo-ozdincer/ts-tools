#!/usr/bin/env python3
"""Plot trajectory statistics for Newton-Raphson minimization grid runs.

This script reads the *_trajectory.json files generated by the grid search,
and creates plots showing stepsize statistics (trust radius, actual displacement,
and condition numbers) over time.
"""

import argparse
import json
import matplotlib
import matplotlib.pyplot as plt
from pathlib import Path
import numpy as np

# Set matplotlib backend to Agg for HPC usage
matplotlib.use('Agg')

def plot_trajectory(traj_path: Path, output_dir: Path):
    with open(traj_path) as f:
        data = json.load(f)
    
    trajectory = data.get("trajectory", [])
    if not trajectory:
        return
    
    sample_id = data.get("sample_id", "unknown_sample")
    method = data.get("method", "unknown_method")
    
    steps = [t["step"] for t in trajectory]
    trust_radii = [t.get("trust_radius", np.nan) for t in trajectory]
    actual_disps = [t.get("actual_step_disp", np.nan) for t in trajectory]
    hit_radius = [t.get("hit_trust_radius", False) for t in trajectory]
    retries = [t.get("retries", 0) for t in trajectory]
    cond_nums = [t.get("cond_num", np.nan) for t in trajectory]
    force_norms = [t.get("force_norm", np.nan) for t in trajectory]
    
    fig, axs = plt.subplots(3, 1, figsize=(10, 12), sharex=True)
    fig.suptitle(f"Minimization Trajectory: {sample_id} ({method})", fontsize=14)
    
    # Plot 1: Trust Radius vs Actual Displacement
    ax = axs[0]
    ax.plot(steps, trust_radii, label="Trust Radius Limit", linestyle="--", color="blue", alpha=0.7)
    ax.plot(steps, actual_disps, label="Actual Max Atom Displacement", color="green")
    
    # Highlight points where trust radius was hit
    hit_steps = [s for s, h in zip(steps, hit_radius) if h]
    hit_disps = [d for d, h in zip(actual_disps, hit_radius) if h]
    if hit_steps:
        ax.scatter(hit_steps, hit_disps, color="red", zorder=5, label="Hit Trust Radius")
        
    ax.set_ylabel("Displacement (Å)")
    ax.set_yscale('log')
    ax.legend(loc="upper right")
    ax.grid(True, alpha=0.3)
    ax.set_title("Step Size Evolution")
    
    # Plot 2: Retries and Force Norm
    ax2 = axs[1]
    color = 'tab:orange'
    ax2.set_ylabel('Force Norm (eV/Å)', color=color)
    ax2.plot(steps, force_norms, color=color, label="Force Norm")
    ax2.tick_params(axis='y', labelcolor=color)
    ax2.set_yscale('log')
    
    ax2_twin = ax2.twinx()
    color = 'tab:purple'
    ax2_twin.set_ylabel('Retries (rejected steps)', color=color)
    ax2_twin.bar(steps, retries, color=color, alpha=0.3, label="Retries")
    ax2_twin.tick_params(axis='y', labelcolor=color)
    
    ax2.set_title("Forces and Step Retries")
    ax2.grid(True, alpha=0.3)
    
    # Plot 3: Condition Number
    ax3 = axs[2]
    ax3.plot(steps, cond_nums, color="brown")
    ax3.set_ylabel("Condition Number")
    ax3.set_yscale('log')
    ax3.set_xlabel("Step")
    ax3.set_title("Hessian Condition Number (|λ_max| / |λ_min|)")
    ax3.grid(True, alpha=0.3)
    
    plt.tight_layout()
    
    out_file = output_dir / f"{traj_path.stem}.png"
    plt.savefig(out_file, dpi=150, bbox_inches='tight')
    plt.close(fig)

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("--grid-dir", required=True, help="Directory containing grid subfolders with diagnostics")
    parser.add_argument("--output-dir", required=True, help="Directory to save PNG plots")
    args = parser.parse_args()
    
    grid_dir = Path(args.grid_dir)
    output_dir = Path(args.output_dir)
    output_dir.mkdir(parents=True, exist_ok=True)
    
    # Find all trajectory json files in the grid directory structure
    traj_files = list(grid_dir.rglob("*_trajectory.json"))
    
    if not traj_files:
        print(f"No trajectory files found in {grid_dir}")
        return
        
    print(f"Found {len(traj_files)} trajectory files to plot.")
    for i, traj_file in enumerate(traj_files):
        if i % 30 != 0:
            continue
            
        # Create subdirectories in the output folder mirroring the grid structure
        rel_path = traj_file.relative_to(grid_dir)
        combo_tag = rel_path.parts[0] if len(rel_path.parts) > 1 else "unknown_combo"
        
        combo_out_dir = output_dir / combo_tag
        combo_out_dir.mkdir(parents=True, exist_ok=True)
        
        plot_trajectory(traj_file, combo_out_dir)
        if (i + 1) % 10 == 0:
            print(f"Processed {i + 1}/{len(traj_files)} files...")
            
    print(f"Done! Plots saved to {output_dir}")

if __name__ == "__main__":
    main()
